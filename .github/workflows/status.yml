name: Get values
on:
  workflow_dispatch:
  push:
  schedule:
    - cron: "*/30 * * * *"

jobs:

  Prepare:
    runs-on: ubuntu-latest
    name: Enable test system
    outputs:
      matrix: ${{steps.list_dirs.outputs.matrix}}
    steps:

      - name: Get runners capacity
        run: |
          
          sudo apt-get -y install datamash
          LIST=$(curl -H "Authorization: Token ${{ secrets.NETBOX_TOKEN }}" -H "Accept: application/json; indent=4" \
          "https://stuff.armbian.com/netbox/api/virtualization/virtual-machines/?limit=500&name__empty=false&tag=github-runner" \
          | jq -r '.results[] | .display, .vcpus, .memory, .cluster.name, .tenant.name' | sed -e 's/^\|$/"/g' \
          | xargs -n5 -d'\n' | sed -e 's/\" \"/\",\"/g'  | tr -d '"' | sed "s/,/\t/g" | datamash --sort -g 4 sum 2,3 --output-delimiter=,)
          (echo "CPU|MEM";
          echo "$LIST" | sed "s/,/\t/g" | datamash --sort sum 2,3  | sed "s/\t/|/g") | jq -Rn '
          ( input  | split("|") ) as $keys |
          ( inputs | split("|") ) as $vals |
          [[$keys, $vals] | transpose[] | {key:.[0],value:.[1]}] | from_entries
          ' > runners_capacity.json

          cat runners_capacity.json

          echo "|Sponsor &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| vCPU Cores |Memory&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|" > label.tmp
          echo "|--|--:|--:|" >> label.tmp
          curl -H "Authorization: Token ${{ secrets.NETBOX_TOKEN }}" -H "Accept: application/json; indent=4" \
          "https://stuff.armbian.com/netbox/api/virtualization/virtual-machines/?limit=500&name__empty=false&tag=github-runner" \
          | jq -r '.results[] | .display, .vcpus, .memory, .cluster.name, .tenant.name' | sed -e 's/^\|$/"/g' \
          | xargs -n5 -d'\n' | sed -e 's/\" \"/\",\"/g'  | tr -d '"' | sed "s/,/\t/g" | datamash --sort -g 5 sum 2,3 --output-delimiter=, \
          | awk -F , -v OFS=\| '$3/=1024' | cut -d"," -f1 | sed -e 's/$/ Gb/g' | sed -e 's/^\|$/|/g' >> label.tmp

          cat label.tmp

      - name: "Upload status"
        uses: ncipollo/release-action@v1
        with:
          artifacts: "runners_capacity.json"
          tag: "status"
          omitBody: true
          omitName: true
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
