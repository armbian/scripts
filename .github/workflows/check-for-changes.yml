name: Changes
on:
  workflow_dispatch:
  workflow_call:
    inputs:
      runner:
        required: true
        type: string
      reference:
        required: true
        type: string

jobs:

  Prepare:
    runs-on: ${{ inputs.runner }}
    name: Source changes
    if: ${{ github.repository_owner == 'Armbian' }}

    steps:

      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 10
          repository: armbian/build
          path: build
          ref:  ${{ inputs.reference }}
          clean: true

      - name: Checkout support scripts
        uses: actions/checkout@v2
        with:
          fetch-depth: 10
          repository: armbian/scripts
          path: scripts
          ref: master
          clean: true

      - name: Remove previous artefacts if any
        run: |
          printenv > 2.txt
          sudo rm -rf changes 2>/dev/null || true

      - name: Determine changed kernels
        run: |

          # fake function
          enable_extension ()
          {
          return 0
          }

          for BRANCH in legacy current edge; do
              FILES=$(cat build/config/targets*.conf | grep $BRANCH | grep -v "^$" | grep -v "^#" | sed -n $LINE'p' | cut -d " " -f1 | uniq)
              while IFS= read -r line; do
               unset LINUXFAMILY KERNELPATCHDIR LINUXCONFIG KERNELSOURCE KERNEL_VERSION_LEVEL
               BOARDFAMILY=$(cat build/config/boards/$line.* | grep BOARDFAMILY | cut -d'"' -f2)
               BOARD=$line
               source build/config/boards/$line.conf 2> /dev/null || true
               source build/config/boards/$line.wip 2> /dev/null || true
               source "build/config/sources/families/${BOARDFAMILY}.conf"
               source "build/config/sources/${ARCH}.conf"
               
               # exceptions handling
               [[ ${BOARDFAMILY} == *x86 ]] && BOARDFAMILY=x86
               [[ ${BOARDFAMILY} == *arm64 ]] && BOARDFAMILY=arm64
               [[ ${BOARDFAMILY} == sun*i ]] && BOARDFAMILY=sunxi
               [[ ${BOARDFAMILY} == sun8i-v3s ]] && BOARDFAMILY=sunxi
               [[ ${BOARDFAMILY} == sun*iw* && ${BRANCH} != legacy ]] && BOARDFAMILY=sunxi64
               [[ ${BOARDFAMILY} == meson8b ]] && BOARDFAMILY=meson
               [[ ${BOARDFAMILY} == meson-* || ${BOARDFAMILY} == jethub ]] && BOARDFAMILY=meson64
               [[ ${BOARDFAMILY} == rk35xx && ${BRANCH} != legacy ]] && BOARDFAMILY=rockchip64
               [[ ${BOARDFAMILY} == rk3399 && ${BRANCH} != legacy ]] && BOARDFAMILY=rockchip64
               [[ ${BOARDFAMILY} == jetson-nano && ${BRANCH} != legacy ]] && BOARDFAMILY=media
               [[ ${BOARDFAMILY} == media && ${BRANCH} == legacy ]] && BOARDFAMILY=station-p2
               [[ ${BOARDFAMILY} == bcm2711 && ${BRANCH} == legacy ]] && continue

                  ref_type=${KERNELBRANCH%%:*}
                  if [[ $ref_type == head ]]; then
                      ref_name=HEAD
                  else
                      ref_name=${KERNELBRANCH##*:}
                  fi
                  [[ -z ${LINUXFAMILY} ]] && LINUXFAMILY=$BOARDFAMILY
                  [[ -z ${KERNELPATCHDIR} ]] && KERNELPATCHDIR=$LINUXFAMILY-$BRANCH
                  [[ -z ${LINUXCONFIG} ]] && LINUXCONFIG=linux-$LINUXFAMILY-$BRANCH
                  [[ -z ${KERNELSOURCE} ]] && KERNELSOURCE="https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux-stable"
               
               echo $BOARD
              done <<< "$FILES"
          done | sort | uniq | sort -u -t: -k1,3

          
      - name: Upload changes
        uses: actions/upload-artifact@v2
        with:
          path: changes
          name: changes
          if-no-files-found: ignore
