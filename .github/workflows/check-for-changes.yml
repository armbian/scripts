name: Changes
on:
  workflow_dispatch:
  workflow_call:
    inputs:
      runner:
        required: true
        type: string
      reference:
        required: true
        type: string

jobs:

  Prepare:
    runs-on: ${{ inputs.runner }}
    name: Source changes
    if: ${{ github.repository_owner == 'Armbian' }}

    steps:

      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 10
          repository: armbian/build
          path: build
          ref:  ${{ inputs.reference }}
          clean: true

      - name: Checkout support scripts
        uses: actions/checkout@v2
        with:
          fetch-depth: 10
          repository: armbian/scripts
          path: scripts
          ref: master
          clean: true

      - name: Remove previous artefacts if any
        run: |
          printenv > 2.txt
          sudo rm -rf changes 2>/dev/null || true

      - name: Determine changed kernels
        run: |

          # fake function
          enable_extension ()
          {
          return 0
          }

          DIFFERENT=$(
          for BRANCH in legacy current edge; do
              FILES=$(cat build/config/targets*.conf | grep $BRANCH | grep -v "^$" | grep -v "^#" | sed -n $LINE'p' | cut -d " " -f1 | uniq)
              while IFS= read -r line; do
                  BOARDFAMILY=$(cat build/config/boards/$line.* | grep BOARDFAMILY | cut -d'"' -f2)
                  echo "build/config/sources/families/${BOARDFAMILY}.conf"
                  done <<< "$FILES"
          done | sort | uniq)

          # read unique only
          while IFS= read -r line; do
              if [[ -f $line ]]; then
                  cat $line
              fi
          done <<< $DIFFERENT
          
      - name: Upload changes
        uses: actions/upload-artifact@v2
        with:
          path: changes
          name: changes
          if-no-files-found: ignore
